// Copyright 2022 PingCAP, Inc. Licensed under Apache-2.0.

package stream_test

import (
	"encoding/hex"
	"encoding/json"

	. "github.com/pingcap/check"
	"github.com/pingcap/log"
	"github.com/pingcap/tidb/parser/model"
	"go.uber.org/zap"
)

type testRewriteMetaRawKvSuite struct{}

var _ = Suite(&testRewriteMetaRawKvSuite{})

func ProduceValue(tableName string, dbID int64) ([]byte, error) {
	tableInfo := model.TableInfo{
		ID:   dbID,
		Name: model.NewCIStr(tableName),
	}

	return json.Marshal(tableInfo)
}

// func (s *testRewriteMetaRawKvSuite) TestRewriteValueForTable(c *C) {
// 	var (
// 		tableName  = "person"
// 		tableID    = 57
// 		newTableID = 63
// 	)

// 	v, err := ProduceValue(tableName, int64(tableID))
// 	c.Assert(err, Equals, nil)
// 	log.Info("old-value", zap.Int("value-len", len(v)), zap.ByteString("old-value", v), logutil.Key("old-value", v))

// 	v, err = ProduceValue(tableName, int64(newTableID))
// 	c.Assert(err, Equals, nil)
// 	log.Info("new-value", zap.Int("value-len", len(v)), zap.ByteString("new-value", v), logutil.Key("new-value", v))
// 	c.Assert(1, Equals, 2)
// }

func (s *testRewriteMetaRawKvSuite) TestRewriteValueForTable2(c *C) {
	str := "7B226964223A35372C226E616D65223A7B224F223A22706572736F6E222C224C223A22706572736F6E227D2C2263686172736574223A22757466386D6234222C22636F6C6C617465223A22757466386D62345F62696E222C22636F6C73223A5B7B226964223A312C226E616D65223A7B224F223A226964222C224C223A226964227D2C226F6666736574223A302C226F726967696E5F64656661756C74223A6E756C6C2C226F726967696E5F64656661756C745F626974223A6E756C6C2C2264656661756C74223A6E756C6C2C2264656661756C745F626974223A6E756C6C2C2264656661756C745F69735F65787072223A66616C73652C2267656E6572617465645F657870725F737472696E67223A22222C2267656E6572617465645F73746F726564223A66616C73652C22646570656E64656E636573223A6E756C6C2C2274797065223A7B225470223A332C22466C6167223A302C22466C656E223A31312C22446563696D616C223A302C2243686172736574223A2262696E617279222C22436F6C6C617465223A2262696E617279222C22456C656D73223A6E756C6C7D2C227374617465223A352C22636F6D6D656E74223A22222C2268696464656E223A66616C73652C226368616E67655F73746174655F696E666F223A6E756C6C2C2276657273696F6E223A327D2C7B226964223A322C226E616D65223A7B224F223A226E616D65222C224C223A226E616D65227D2C226F6666736574223A312C226F726967696E5F64656661756C74223A6E756C6C2C226F726967696E5F64656661756C745F626974223A6E756C6C2C2264656661756C74223A6E756C6C2C2264656661756C745F626974223A6E756C6C2C2264656661756C745F69735F65787072223A66616C73652C2267656E6572617465645F657870725F737472696E67223A22222C2267656E6572617465645F73746F726564223A66616C73652C22646570656E64656E636573223A6E756C6C2C2274797065223A7B225470223A31352C22466C6167223A302C22466C656E223A3235352C22446563696D616C223A302C2243686172736574223A22757466386D6234222C22436F6C6C617465223A22757466386D62345F62696E222C22456C656D73223A6E756C6C7D2C227374617465223A352C22636F6D6D656E74223A22222C2268696464656E223A66616C73652C226368616E67655F73746174655F696E666F223A6E756C6C2C2276657273696F6E223A327D2C7B226964223A332C226E616D65223A7B224F223A226269727468646179222C224C223A226269727468646179227D2C226F6666736574223A322C226F726967696E5F64656661756C74223A6E756C6C2C226F726967696E5F64656661756C745F626974223A6E756C6C2C2264656661756C74223A6E756C6C2C2264656661756C745F626974223A6E756C6C2C2264656661756C745F69735F65787072223A66616C73652C2267656E6572617465645F657870725F737472696E67223A22222C2267656E6572617465645F73746F726564223A66616C73652C22646570656E64656E636573223A6E756C6C2C2274797065223A7B225470223A31302C22466C6167223A3132382C22466C656E223A31302C22446563696D616C223A302C2243686172736574223A2262696E617279222C22436F6C6C617465223A2262696E617279222C22456C656D73223A6E756C6C7D2C227374617465223A352C22636F6D6D656E74223A22222C2268696464656E223A66616C73652C226368616E67655F73746174655F696E666F223A6E756C6C2C2276657273696F6E223A327D2C7B226964223A342C226E616D65223A7B224F223A226772616465222C224C223A226772616465227D2C226F6666736574223A332C226F726967696E5F64656661756C74223A2230222C226F726967696E5F64656661756C745F626974223A6E756C6C2C2264656661756C74223A6E756C6C2C2264656661756C745F626974223A6E756C6C2C2264656661756C745F69735F65787072223A66616C73652C2267656E6572617465645F657870725F737472696E67223A22222C2267656E6572617465645F73746F726564223A66616C73652C22646570656E64656E636573223A6E756C6C2C2274797065223A7B225470223A332C22466C6167223A343039372C22466C656E223A31312C22446563696D616C223A302C2243686172736574223A2262696E617279222C22436F6C6C617465223A2262696E617279222C22456C656D73223A6E756C6C7D2C227374617465223A312C22636F6D6D656E74223A22222C2268696464656E223A66616C73652C226368616E67655F73746174655F696E666F223A6E756C6C2C2276657273696F6E223A327D5D2C22696E6465785F696E666F223A6E756C6C2C22636F6E73747261696E745F696E666F223A6E756C6C2C22666B5F696E666F223A6E756C6C2C227374617465223A352C22706B5F69735F68616E646C65223A66616C73652C2269735F636F6D6D6F6E5F68616E646C65223A66616C73652C22636F6D6D6F6E5F68616E646C655F76657273696F6E223A302C22636F6D6D656E74223A22222C226175746F5F696E635F6964223A302C226175746F5F69645F6361636865223A302C226175746F5F72616E645F6964223A302C226D61785F636F6C5F6964223A342C226D61785F6964785F6964223A302C226D61785F6373745F6964223A302C227570646174655F74696D657374616D70223A3433313430363837343637353634323337312C225368617264526F77494442697473223A302C226D61785F73686172645F726F775F69645F62697473223A302C226175746F5F72616E646F6D5F62697473223A302C227072655F73706C69745F726567696F6E73223A302C22706172746974696F6E223A6E756C6C2C22636F6D7072657373696F6E223A22222C2276696577223A6E756C6C2C2273657175656E6365223A6E756C6C2C224C6F636B223A6E756C6C2C2276657273696F6E223A342C227469666C6173685F7265706C696361223A6E756C6C2C2269735F636F6C756D6E6172223A66616C73652C2274656D705F7461626C655F74797065223A302C2263616368655F7461626C655F737461747573223A302C22706F6C6963795F7265665F696E666F223A6E756C6C2C22706C6163656D656E745F73657474696E6773223A6E756C6C2C2273746174735F6F7074696F6E73223A6E756C6C7D"
	value, err := hex.DecodeString(str)
	c.Assert(err, Equals, nil)

	tableInfo := model.TableInfo{}
	err = json.Unmarshal(value, &tableInfo)
	c.Assert(err, Equals, nil)
	log.Info("table", zap.Int("len", len(value)), zap.ByteString("value", value))

	value2, err := json.Marshal(&tableInfo)
	c.Assert(err, Equals, nil)
	log.Info("table", zap.Int("len", len(value2)), zap.ByteString("value", value2))

	err = json.Unmarshal(value2, &tableInfo)
	c.Assert(err, Equals, nil)
}
